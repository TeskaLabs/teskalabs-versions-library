# LogMan.io v25.30 Release Notes

## Breaking Changes

- The descriptor for NGINX has changed. Please review and update any custom changes related to SSL curves.
- Correlators and Baseliners are now managed by the LMIO T-Rex microservice. You need to remove all existing instances of the `lmio-correlator` and `lmio-baseliner` services from your `model.yaml` file before upgrading.

## Features

- Added API key management.
- Added support for internal network interfaces.
- Added support for custom CA certificates for the Library Git provider.
- Added support for different SMS phone numbers for different tenants.
- Added support for terms aggregation in Elasticsearch in Reports/Exports.
- Introduced the **LMIO Parser Builder**, allowing users to create and manage custom parsers via the Web UI.
- Introduced the **LMIO T-Rex** service, enabling users to create and manage Baseliners, Correlations, and Detections via the Web UI.
- Added support for automatic management of Kibana index patterns (data views) by LMIO Elman.
- Added support for automatic management of Data Lifecycle Management policies for Event Lanes by LMIO Elman.
- The default lookup enricher is now used instead of the declared enricher in the Library.
- The fields `lmio.logsource.ip`, `lmio.logsource.port`, and `lmio.logsource.protocol` are now added to unparsed events. The `lmio.logsource.protocol` field now has a descriptive name.
- Parsing performance has been optimized.
- Added signal grouping based on risk score in alert management.
- Added support for pagination in the timeline screen for alert management.
- Added support for email, Slack, and SMS notifications in alert management.
- Added support for automatic ticket closing in alert management.
- Added support for running custom scripts for integration with other SIEM systems in Event Lanes.

## Upgrade Procedure v25.28 â†’ v25.30

This release includes several important changes that require manual actions before and after the upgrade. Please follow the instructions below carefully.

### Before the upgrade

1. NGINX configuration will be changed. All requests will be redirected to `PUBLIC_URL` configured in the section `params` of the `model.yaml`.
    ```yaml
    params:
      PUBLIC_URL: "https://logman.yourdomain.com"
    ```

    **Make sure you can resolve the PUBLIC_URL from your working station.** Add it to the `hosts` file on each server node if needed.

2. NGINX configuration will be changed. Revise custom changes made in `/Site/ASAB Maestro/Descriptors/nginx.yaml` or in `/Site/ASAB Maestro/Files/nginx/` folder. Apply the content from the base layer.

3. Correlators and Baseliners will be automatically deployed by the LMIO T-Rex microservice. Therefore, you need to remove all existing instances of the `lmio-correlator` and `lmio-baseliner` services from your `model.yaml` file.

    Remember the list of enabled Correlation rules and Detections, as you will need to enable them again after the upgrade.

    ```yaml
    services:

      # Remove these lines...
      lmio-correlator-<tenant>-<group>:
        - your-node

      lmio-baseliner-<tenant>:
        - your-node
    ```

    Apply the changes.

4. Kibana index patterns (data views) for specific event lanes, events, and others will be automatically created and managed by LMIO Elman v25.30. Remove all manually created index patterns (data views) of the form `lmio-tenant-events-<eventlane>*`, `lmio-tenant-events*`, and `lmio-tenant-others*` to avoid conflicts. You can keep other manually created index patterns (data views) if needed.

    Open the Kibana UI, go to **Stack Management > Index Patterns** (or Data Views), and delete the relevant index patterns (data views). Repeat this for every tenant.

5. Data Lifecycle Management policies for LMIO indices will be automatically created and managed by LMIO Elman v25.30.

    Add the following snippet to every event lane definition in `/EventLanes/<tenant>/<eventlane>.yaml`:

    ```yaml
    define:
      type: lmio/event-lane
      # Add the following line
      profile: /Profiles/EventLanes/Default.yaml
    ```

    All custom Archive definitions will be overwritten after the upgrade. You can customize them in profiles globally or in individual event lanes.

    If you want to customize it for a specific event lane, add the following snippet to the respective event lane definition file:

    ```yaml
    define:
      type: lmio/event-lane

    # Add the following section to customize Archive settings
    archive:
      lifecycle:
        cold:
        - compress:
            preset: 6
            threads: 4
            type: xz
        - delete:
            age: 18M
        hot:
        - copy:
            phase: cold
        - move:
            age: 1d
            phase: warm
        warm:
        - delete:
            age: 3M
    ```

    To customize it globally for all event lanes, create a new profile or modify the profile at `/Profiles/EventLanes/Default.yaml`.

    Once the event lane definition is updated, changes are applied automatically. No further action is needed.

### Upgrade

1. Change the version of LogMan.io in your `model.yaml` file to `v25.30`:

    ```yaml
    applications:
      - name: "ASAB Maestro"
        version: v25.30
      - name: "LogMan.io"
        version: v25.30
    ```

    Apply the changes.

2. Wait until all services are pulled and started.

3. Apply the changes again. This ensures that the latest versions of libraries used by LogMan.io services are pulled.

4. Wait until all services are started again.

### After the upgrade

1. Make sure that the nginx configuration is applied form the base layer of the library. If you use any custom configuration of nginx files outside of the model.yaml, make sure you adjust the new base content.

2. Add the **LMIO Parser Builder** service definition to your `model.yaml` file:

    ```yaml
    services:
      lmio-parser-builder:
        - your-node
    ```

    Apply the changes.

    To ensure Parser Builder screen is available in the Web UI, check the following lines in `/Site/ASAB Maestro/WebApps/LogMan.io WebUI.yaml`:

3. Add the **LMIO T-Rex** service definition to your `model.yaml` file:

    ```yaml
    services:
      lmio-trex:
        - your-node
    ```

    Apply the changes.

    To ensure the Detection screen is available in the Web UI, check the following lines in `/Site/ASAB Maestro/WebApps/LogMan.io WebUI.yaml`:

4. Open the Detection screen in the Web UI. Select the Correlations and Detections you want to enable, and click the Apply button. Repeat this for every tenant.

    LMIO T-Rex will automatically deploy Correlators for the selected Correlations and Detections. It creates its own model files for each tenant at `/Site/model-trex-<tenant_name>.yaml`.

    LMIO T-Rex will also automatically deploy Baseliners for every tenant. No further action is needed.

5. Due to changes in Kafka Consumer group names for Correlators, a new Consumer group may be created when the Correlator starts. The old Consumer group is not automatically deleted. You can delete the old Consumer groups manually using Kafka management tools.

    To delete the old Consumer group, connect to one of your Kafka nodes and run the following command:

    ```shell
    tladmin@node-1:~# docker exec -it kafka-1 bash
    [root@kafka-1 appuser]# /usr/bin/kafka-consumer-groups --bootstrap-server localhost:9092 --delete --group <old_consumer_group_name>
    ```

6. Enable **ZooKeeper monitoring** in Grafana dashboards. On every node running ZooKeeper, edit the `zoo.cfg` file located at `/data/hdd/zookeeper-<n>/conf/zoo.cfg`.

    ```shell
    tladmin@node-1:~# vim /data/hdd/zookeeper-1/conf/zoo.cfg
    ```

    Change the `4lw.commands.whitelist` property to include the `mntr` command:

    ```conf
    4lw.commands.whitelist=stat, ruok, conf, srst, isro, cons, crst, envi, srvr, dirs, mntr
    ```

    Restart the ZooKeeper service to apply the changes:

    ```shell
    tladmin@node-1:~# docker restart zookeeper-1
    ```

    To confirm that the `mntr` command is enabled, run the following command:

    ```shell
    tladmin@node-1:~# echo mntr | nc localhost 2181 | head -n 1
    zk_version	3.9.3-c26634f34490bb0ea7a09cc51e05ede3b4e320ee, built on 2024-10-17 23:21 UTC
    ```

### ECS Schema Changes

The ECS Schema provided by Common Library v25.30 has been updated. If you are using a custom schema, please review the changes below and update your custom schema accordingly.

#### Removed alert section

Some fields previously required the `alert` section, which has now been removed.

#### Added enrich section

Some fields now contain the `enrich` section, which is used for automatic enrichments. The fields are:

- user.name
- host.hostname
- source.ip
- destination.ip
- client.ip

#### Added ECS Fields

- source.vlan.id
- source.subnet.id
- destination.vlan.id
- destination.subnet.id
- client.vlan.id
- client.subnet.id
- lmio.nas.ip
- lmio.nas.port.id
- lmio.nas.port.type
- lmio.nas.port.number
- lmio.session.id
- fortinet.firewall.url.category.id
- fortinet.firewall.url.category.description
- we.status_code

#### Removed ECS Fields

- pe.go_imports
- pe.imports
- cisco.code
- cisco.bytes
- cisco.message.id
- cisco.message.type
- cisco.result
- cisco_ise.log.endpoint.mac.address
- cisco_ise.log.server.name
- cisco.source.host
- f5.session.id
- ftp.session.id
- oracle.session.id
- we.status
